Bootstrap: docker
From: ubuntu:22.04

%files
  src /app/src
  config /app/config
  pyproject.toml /app/pyproject.toml
  uv.lock /app/uv.lock

%post
  apt-get update && \
    apt-get install -y wget gnupg && \
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb && \
    dpkg -i cuda-keyring_1.1-1_all.deb && \
    apt-get update

  apt-get install --no-install-recommends -y \
    cuda-11-8 \
    build-essential \
    libssl-dev \
    zlib1g-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    curl \
    vim \
    libncurses-dev \
    libffi-dev \
    liblzma-dev \
    python3-openssl \
    git \
    ffmpeg

  apt-get clean && rm -rf /var/lib/apt/lists/*

  mkdir -p /cargo
  curl -LsSf https://astral.sh/uv/install.sh | CARGO_HOME=/cargo sh
  export PATH="/root/.local/bin:$PATH"

  . $HOME/.local/bin/en
  cd /app
  uv sync --locked

%runscript
  . $HOME/.local/bin/env
  cd /app
  uv run main.py "$@"

%labels
  Author k.a.gibb@sussex.ac.uk
  Version v1.0.0
